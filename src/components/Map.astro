---
interface Props {
  gpxFile?: string;
  height?: string;
  center?: [number, number];
  zoom?: number;
}

const {
  gpxFile,
  height = '500px',
  center = [64.0685, -138.4414], // Default to Dempster Highway area
  zoom = 6
} = Astro.props;

const mapId = `map-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="map-container my-8 rounded-lg overflow-hidden border border-[rgb(var(--color-border))]">
  <div id={mapId} style={`height: ${height}`} class="w-full"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script define:vars={{ mapId, gpxFile, center, zoom }}>
  async function initMap() {
    const L = await import('leaflet');

    const map = L.default.map(mapId, {
      scrollWheelZoom: false
    }).setView(center, zoom);

    L.default.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19,
    }).addTo(map);

    map.on('click', function() {
      if (!map.scrollWheelZoom.enabled()) {
        map.scrollWheelZoom.enable();
      }
    });

    map.on('mouseout', function() {
      map.scrollWheelZoom.disable();
    });

    if (gpxFile) {
      try {
        const response = await fetch(gpxFile);
        const gpxText = await response.text();

        const parser = new DOMParser();
        const gpxDoc = parser.parseFromString(gpxText, 'text/xml');

        const trackPoints = gpxDoc.querySelectorAll('trkpt');
        const coordinates = [];

        trackPoints.forEach(point => {
          const lat = parseFloat(point.getAttribute('lat'));
          const lon = parseFloat(point.getAttribute('lon'));
          coordinates.push([lat, lon]);
        });

        if (coordinates.length > 0) {
          const polyline = L.default.polyline(coordinates, {
            color: 'rgb(37, 99, 235)',
            weight: 3,
            opacity: 0.8
          }).addTo(map);

          map.fitBounds(polyline.getBounds(), { padding: [50, 50] });

          L.default.marker(coordinates[0], {
            icon: L.default.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            })
          }).addTo(map).bindPopup('Start');

          L.default.marker(coordinates[coordinates.length - 1], {
            icon: L.default.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            })
          }).addTo(map).bindPopup('End');
        }
      } catch (error) {
        console.error('Error loading GPX file:', error);
      }
    }
  }

  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMap);
    } else {
      initMap();
    }
  }
</script>

<style>
  .map-container :global(.leaflet-container) {
    background: rgb(var(--color-bg));
  }

  .map-container :global(.leaflet-control-attribution) {
    font-size: 11px;
  }
</style>
